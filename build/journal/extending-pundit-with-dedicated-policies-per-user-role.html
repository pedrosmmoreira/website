<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Extending Pundit with dedicated policies per user role - Pedro Moreira</title>
    <meta name="description" content="Refactoring complex authorization logic in Rails by creating role-specific Pundit policies.">
    <meta property="og:title" content="Extending Pundit with dedicated policies per user role - Pedro Moreira">
    <meta property="og:description" content="Refactoring complex authorization logic in Rails by creating role-specific Pundit policies.">
    <meta property="og:url" content="https://pedrosmmoreira.com/journal/extending-pundit-with-dedicated-policies-per-user-role">
    <meta property="og:image" content="https://pedrosmmoreira.com/icon.png">
    <meta property="og:type" content="article">
    <meta property="og:site_name" content="Pedro Moreira">
    <meta name="twitter:card" content="summary">
    <meta name="twitter:title" content="Extending Pundit with dedicated policies per user role - Pedro Moreira">
    <meta name="twitter:description" content="Refactoring complex authorization logic in Rails by creating role-specific Pundit policies.">
    <meta name="twitter:image" content="https://pedrosmmoreira.com/icon.png">
    <link rel="canonical" href="https://pedrosmmoreira.com/journal/extending-pundit-with-dedicated-policies-per-user-role">
    <meta name="csrf-param" content="authenticity_token" />
<meta name="csrf-token" content="D92iYlXCm1ojWHRsE3HBSBSWHY9mJwm-x9MFvtFZAsJqAoLc4LGEo5xRACi-J8EIBKEn1ffqQJwZZTSLhxHXaw" />
    
    <link rel="stylesheet" href="/assets/application-3c335096.css" />
    <script type="importmap" data-turbo-track="reload">{
  "imports": {
    "application": "/assets/application-d8a8613a.js"
  }
}</script>
<link rel="modulepreload" href="/assets/application-d8a8613a.js">
<script type="module">import "application"</script>
    <script type="application/ld+json">
  {
  "@context": "https://schema.org",
  "@type": "Person",
  "name": "Pedro Moreira",
  "url": "https://pedrosmmoreira.com",
  "description": "Engineering leader building reliable systems and growing reliable teams. 11 years across fintech, cleantech, and government digital services.",
  "knowsAbout": [
    "Engineering Leadership",
    "Backend Engineering",
    "Software Reliability",
    "Engineering Management",
    "Open Source Software",
    "Fintech",
    "Cleantech"
  ],
  "sameAs": [
    "https://github.com/pedrosmmoreira",
    "https://x.com/pedrosmmoreira",
    "https://www.linkedin.com/in/pedrosmmoreira"
  ],
  "alumniOf": [
    {
      "@type": "Organization",
      "name": "Ventrata",
      "url": "https://ventrata.com"
    },
    {
      "@type": "Organization",
      "name": "char.gy",
      "url": "https://char.gy"
    },
    {
      "@type": "Organization",
      "name": "Specle",
      "url": "https://specle.net"
    },
    {
      "@type": "Organization",
      "name": "Unboxed Consulting",
      "url": "https://unboxed.co"
    }
  ],
  "nationality": {
    "@type": "Country",
    "name": "Portugal"
  },
  "homeLocation": {
    "@type": "Place",
    "name": "Porto, Portugal"
  }
}
</script>

    
  </head>
  <body>
    <header>
  <nav>
    <div class="site-identity">
      <a class="site-name" href="/">Pedro Moreira</a>
      <span class="site-tagline">Building reliable systems &amp; growing reliable teams</span>
    </div>
  </nav>
</header>

    <main>
      
<article class="article">
  <header class="article-header">
    <time datetime="2016-11-09">November 9, 2016</time>
    <h1>Extending Pundit with dedicated policies per user role</h1>
      <p class="article-description">Refactoring complex authorization logic in Rails by creating role-specific Pundit policies.</p>
  </header>

  <div class="prose">
    <p>I am a big fan of using Pundit for authorization. It is simple, easy to implement and extensible. On a recent project, we had to deal with multiple user roles and as such we were starting to get a quite complex policy object. In particular we had to start checking the type of user we had, leading to complex logic branches:</p>
<pre class="highlight"><code><span class="k">class</span> <span class="nc">FooPolicy</span> <span class="o">&lt;</span> <span class="no">ApplicationPolicy</span>
  <span class="c1">#...</span>
  <span class="k">class</span> <span class="nc">Scope</span>
    <span class="c1">#...</span>
    <span class="k">def</span> <span class="nf">resolve</span>
      <span class="k">if</span> <span class="n">user</span><span class="p">.</span><span class="nf">roles</span><span class="p">.</span><span class="nf">include?</span><span class="p">(</span><span class="s2">"admin"</span><span class="p">)</span>
        <span class="n">scope</span><span class="p">.</span><span class="nf">not_cancelled</span>
      <span class="k">elsif</span> <span class="n">user</span><span class="p">.</span><span class="nf">roles</span><span class="p">.</span><span class="nf">include?</span><span class="p">(</span><span class="s2">"official"</span><span class="p">)</span>
        <span class="n">scope</span><span class="p">.</span><span class="nf">not_draft</span>
      <span class="k">elsif</span> <span class="n">user</span><span class="p">.</span><span class="nf">roles</span><span class="p">.</span><span class="nf">include?</span><span class="p">(</span><span class="s2">"provider"</span><span class="p">)</span>
        <span class="n">scope</span><span class="p">.</span><span class="nf">provided_by</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
      <span class="k">else</span>
        <span class="n">scope</span><span class="p">.</span><span class="nf">none</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">show?</span>
    <span class="p">(</span><span class="n">provider</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">record</span><span class="p">.</span><span class="nf">cancelled?</span><span class="p">)</span> <span class="o">||</span>
    <span class="p">(</span><span class="n">official</span> <span class="o">||</span> <span class="n">user_is_assigned_provider?</span><span class="p">(</span><span class="n">user</span><span class="p">))</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<p>This is solely for resolving a Scope of records accessible by an user. You can imagine how complex the logic for permitting an individual action can get at this point.</p>

<p>As more actions needed additional conditional logic, we started to encounter small bugs and our tests became less and less clear as source of truth for <em>who could do what</em>.</p>

<p>Our first step was to actually write the code we wish we had and let our integration tests guide the refactoring, starting from the top of the conditional branch in the resolve block:</p>
<pre class="highlight"><code><span class="k">class</span> <span class="nc">AdminFooPolicy</span> <span class="o">&lt;</span> <span class="no">ApplicationPolicy</span>
  <span class="k">class</span> <span class="nc">Scope</span>
    <span class="nb">attr_reader</span> <span class="ss">:user</span><span class="p">,</span> <span class="ss">:scope</span>

    <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
      <span class="vi">@user</span> <span class="o">=</span> <span class="n">user</span>
      <span class="vi">@scope</span> <span class="o">=</span> <span class="n">context</span><span class="p">.</span><span class="nf">record</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">resolve</span>
      <span class="n">scope</span><span class="p">.</span><span class="nf">not_cancelled?</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="n">user</span>
    <span class="vi">@record</span> <span class="o">=</span> <span class="n">context</span><span class="p">.</span><span class="nf">record</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">show?</span>
    <span class="o">!</span><span class="n">record</span><span class="p">.</span><span class="nf">cancelled?</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<p>Since Pundit policies are based on a user and a record being passed in, or in the case of a Scope, a class name, we knew we had to provide some additional context in order for this to work. Passing additional arguments to the policy would not help our case, since we needed a dynamic way of instantiating the correct policy object for each of our users. Our next port of call was to investigate how Pundit itself retrieves policy objects. We quickly found the answer in the <code>PolicyFinder</code> class.</p>

<p>Pundit checks if the passed in object responds to a instance or class policy<em>class method. Failing that it assigns the klass local variable to the objects model name or class and appends the value of SUFFIX, which is &quot;Policy&quot;. Armed with this knowledge it becomes simple to implement our requirement: we need to wrap the object we pass to Pundit with something that responds to policy</em>class, returning the correct name of the policy to instantiate.</p>

<p>For there on, it was easy to arrive at our solution:</p>
<pre class="highlight"><code><span class="k">class</span> <span class="nc">PolicyContext</span>
  <span class="nb">attr_reader</span> <span class="ss">:record</span>

  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">record</span><span class="p">,</span> <span class="n">user</span><span class="p">)</span>
    <span class="vi">@record</span> <span class="o">=</span> <span class="n">record</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="n">user</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">policy_class</span>
    <span class="s2">"</span><span class="si">#{</span><span class="vi">@user</span><span class="p">.</span><span class="nf">role</span><span class="si">}</span><span class="s2">FooPolicy"</span><span class="p">.</span><span class="nf">classify</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<p>Given an User with a role of admin, our policy class method will respond with &quot;AdminFooPolicy&quot;, which Pundit will then constantize and initiate. We expose a reader for the record so that we can then unwrap the record to authorize in our policy object.</p>

<p>This will work both with instantiating a record policy, a scope policy and a specific controller action. The calls in our controller now look like this:</p>
<pre class="highlight"><code><span class="k">class</span> <span class="nc">FoosController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="kp">include</span> <span class="no">Pundit</span>
  <span class="c1">#...</span>

  <span class="c1"># record policy</span>
  <span class="k">def</span> <span class="nf">set_record_policy</span>
    <span class="n">policy</span><span class="p">(</span><span class="no">PolicyContext</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="n">record</span><span class="p">,</span> <span class="n">current_user</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="c1"># scope policy</span>
  <span class="k">def</span> <span class="nf">set_policy_scope</span>
    <span class="n">policy_scope</span><span class="p">(</span><span class="no">PolicyContext</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="no">RecordClassName</span><span class="p">,</span> <span class="n">current_user</span><span class="p">))</span>
  <span class="k">end</span>

  <span class="c1"># authorizing controller action</span>
  <span class="k">def</span> <span class="nf">authorize_action</span>
    <span class="n">authorize</span> <span class="no">PolicyContext</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="n">record</span><span class="p">,</span> <span class="n">user</span><span class="p">),</span> <span class="s2">"</span><span class="si">#{</span><span class="n">action_name</span><span class="si">}</span><span class="s2">?"</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<p>Our tests per individual policy are now much cleaner and we&#39;ve managed to get rid of a lot of conditional logic and subsequent potential for hidden bugs.</p>

  </div>
</article>

    </main>
    <footer>
  <p>
    <a href="https://github.com/pedrosmmoreira">GitHub</a>
    <a href="https://x.com/pedrosmmoreira">X</a>
    <a href="https://www.linkedin.com/in/pedrosmmoreira">LinkedIn</a>
  </p>
</footer>

  </body>
</html>
